
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wind Sensor Code &#8212; fwx-wind 2022 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Wind Tunnel Build" href="windbuild.html" />
    <link rel="prev" title="The Expendable Wind Sensor" href="thesensor.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/expendable_sensors.jpg" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents:
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="thesensor.html">
   The Expendable Wind Sensor
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Wind Sensor Code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="windbuild.html">
   Wind Tunnel Build
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="windtests.html">
   Wind Tunnel Tests
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/code.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Wind Sensor Code</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="wind-sensor-code">
<h1>Wind Sensor Code<a class="headerlink" href="#wind-sensor-code" title="Permalink to this headline">#</a></h1>
<p>The sensors are controlled by Arduino sketches. Three modules from Arduino were used.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;TimerOne.h&quot;</span>
<span class="c1">#include &lt;math.h&gt;</span>
<span class="c1">#include &lt;SD.h&gt;</span>
<span class="c1">#include &lt;SPI.h&gt;</span>
</pre></div>
</div>
<p>Two pins are used to read the wind speed and wind direction from the davis sensor. Wind speed is connected to a digital pin and wind direction is connected to a analog pin. If testing indicated the wind vane having an offset from the intented rest position, it can also be defined as a variable here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define WindSensor_Pin (2) // digital pin for wind speed sensor</span>
<span class="c1">#define WindVane_Pin (A4) // analog pin for wind direction sensor</span>
<span class="c1">#define VaneOffset 0 // define the offset for caclulating wind direction</span>
</pre></div>
</div>
<p>Next, we will set the variables for the sketch.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volatile</span> <span class="nb">bool</span> <span class="n">isSampleRequired</span><span class="p">;</span> <span class="o">//</span> <span class="n">this</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">every</span> <span class="mf">2.5</span><span class="n">sec</span> <span class="n">to</span> <span class="n">generate</span> <span class="n">wind</span> <span class="n">speed</span>
<span class="n">volatile</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">timerCount</span><span class="p">;</span> <span class="o">//</span> <span class="n">used</span> <span class="n">to</span> <span class="n">count</span> <span class="n">ticks</span> <span class="k">for</span> <span class="mf">2.5</span><span class="n">sec</span> <span class="n">timer</span> <span class="n">count</span>
<span class="n">volatile</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="n">rotations</span><span class="p">;</span> <span class="o">//</span> <span class="n">cup</span> <span class="n">rotation</span> <span class="n">counter</span> <span class="k">for</span> <span class="n">wind</span> <span class="n">speed</span> <span class="n">calcs</span>
<span class="n">volatile</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="n">contactBounceTime</span><span class="p">;</span> <span class="o">//</span> <span class="n">timer</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">contact</span> <span class="n">bounce</span> <span class="ow">in</span> <span class="n">wind</span> <span class="n">speed</span> <span class="n">sensor</span>
<span class="n">volatile</span> <span class="nb">float</span> <span class="n">windSpeed</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">vaneValue</span><span class="p">;</span> <span class="o">//</span> <span class="n">raw</span> <span class="n">analog</span> <span class="n">value</span> <span class="kn">from</span> <span class="nn">wind</span> <span class="n">vane</span>
<span class="nb">int</span> <span class="n">vaneDirection</span><span class="p">;</span> <span class="o">//</span> <span class="n">translated</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">360</span> <span class="n">wind</span> <span class="n">direction</span>
<span class="nb">int</span> <span class="n">calDirection</span><span class="p">;</span> <span class="o">//</span> <span class="n">calibrated</span> <span class="n">direction</span> <span class="n">after</span> <span class="n">offset</span> <span class="n">applied</span>
<span class="nb">int</span> <span class="n">lastDirValue</span><span class="p">;</span> <span class="o">//</span> <span class="n">last</span> <span class="n">recorded</span> <span class="n">direction</span> <span class="n">value</span>

<span class="n">const</span> <span class="nb">int</span> <span class="n">chipSelect</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="o">//</span> <span class="n">pin</span> <span class="k">with</span> <span class="n">sd</span> <span class="n">card</span> <span class="n">connected</span>
</pre></div>
</div>
<p>And setup a file for data to be written to.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">char</span> <span class="n">fileName</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">&quot;windtest.txt&quot;</span><span class="p">;</span>
<span class="n">static</span> <span class="n">char</span> <span class="n">header</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time</span><span class="se">\t</span><span class="s2">wsp</span><span class="se">\t</span><span class="s2">wdir&quot;</span><span class="p">};</span>
</pre></div>
</div>
<p>We can now get started with the bulk of the code. Here we will setup a loop to reset the senors and ensure everything is connected properly.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">This</span> <span class="n">prevents</span> <span class="nb">any</span> <span class="n">pins</span> <span class="n">floating</span><span class="o">.</span>
  <span class="o">//</span><span class="k">for</span> <span class="p">(</span><span class="n">byte</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">19</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="o">//</span>  <span class="n">pinMode</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">INPUT_PULLUP</span><span class="p">);</span>
    
  <span class="o">//</span> <span class="n">setup</span> <span class="n">anemometer</span> <span class="n">values</span>
  <span class="n">lastDirValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">rotations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">isSampleRequired</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">setup</span> <span class="n">timer</span> <span class="n">values</span>
  <span class="n">timerCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">Serial</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;UBC Wind Sensor&quot;</span><span class="p">);</span>

  <span class="n">Serial</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SD</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">chipSelect</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;SD card is present &amp; ready&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;SD card missing or failure&quot;</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="o">//</span><span class="n">wait</span> <span class="n">here</span> <span class="n">forever</span>
  <span class="p">}</span>

  <span class="n">File</span> <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">FILE_WRITE</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">myFile</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">myFile</span><span class="o">.</span><span class="n">println</span><span class="p">((</span><span class="n">char</span><span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">);</span>
    <span class="n">myFile</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">((</span><span class="n">char</span><span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;error opening .txt&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">pinMode</span><span class="p">(</span><span class="n">WindSensor_Pin</span><span class="p">,</span> <span class="n">INPUT_PULLUP</span><span class="p">);</span>
  <span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">WindSensor_Pin</span><span class="p">),</span> <span class="n">isr_rotation</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>

  <span class="o">//</span><span class="n">pinMode</span><span class="p">(</span><span class="n">WindSensor_Pin</span><span class="p">,</span> <span class="n">INPUT_PULLUP</span><span class="p">);</span>
  <span class="o">//</span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">WindSensor_Pin</span><span class="p">),</span> <span class="n">isr_rotation</span><span class="p">,</span> <span class="n">RISING</span><span class="p">);</span>

  <span class="o">//</span> <span class="n">setup</span> <span class="n">the</span> <span class="n">timer</span> <span class="k">for</span> <span class="mf">0.5</span> <span class="n">second</span>
  <span class="n">Timer1</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="mi">500000</span><span class="p">);</span>
  <span class="n">Timer1</span><span class="o">.</span><span class="n">attachInterrupt</span><span class="p">(</span><span class="n">isr_timer</span><span class="p">);</span>

 <span class="n">sei</span><span class="p">();</span> <span class="o">//</span> <span class="n">Enable</span> <span class="n">Interrupts</span>

<span class="p">}</span>
</pre></div>
</div>
<p>With the sensor preopped, we will now setup a loop to write wind speed and direction to the ouput file. The sensor does not have an internal clock, but does keep track of the milliseconds elapsed since power was introduced. Due to memory limits though, it can only keep track of a certain number of milliseconds. Thus, we need to convert them to hours:minutes:seconds.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>

<span class="o">//</span>    <span class="n">getWindDirection</span><span class="p">();</span>
<span class="o">//</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">calDirection</span> <span class="o">-</span> <span class="n">lastDirValue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
<span class="o">//</span>      <span class="n">lastDirValue</span> <span class="o">=</span> <span class="n">calDirection</span><span class="p">;</span>
<span class="o">//</span>    <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">isSampleRequired</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">getWindDirection</span><span class="p">();</span>
    <span class="n">unsigned</span> <span class="n">long</span> <span class="n">prMillis</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">prMillis</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">;</span>
    <span class="p">}</span>
    <span class="n">prMillis</span> <span class="o">=</span> <span class="n">millis</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="n">byte</span> <span class="n">sec</span> <span class="o">=</span> <span class="n">prMillis</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">prMillis</span> <span class="o">=</span> <span class="n">prMillis</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">byte</span> <span class="nb">min</span> <span class="o">=</span> <span class="n">prMillis</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">prMillis</span> <span class="o">=</span> <span class="n">prMillis</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">byte</span> <span class="n">hrs</span> <span class="o">=</span> <span class="n">prMillis</span> <span class="o">%</span> <span class="mi">24</span><span class="p">;</span>

    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">hrs</span><span class="p">);</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="nb">min</span><span class="p">);</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">sec</span><span class="p">);</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">);</span>

    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">windSpeed</span><span class="p">);</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot; mph</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">calDirection</span><span class="p">);</span>
  
    <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">);</span>
    <span class="n">File</span> <span class="n">myFile</span> <span class="o">=</span> <span class="n">SD</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">FILE_WRITE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myFile</span><span class="p">)</span> <span class="o">//</span> <span class="n">it</span> <span class="n">opened</span> <span class="n">OK</span>
    <span class="p">{</span>
      <span class="o">//</span><span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;Writing to windtest.txt&quot;</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">hrs</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="nb">min</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">sec</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">windSpeed</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">calDirection</span><span class="p">);</span>
      <span class="n">myFile</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
      <span class="n">Serial</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;Error opening simple.txt&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">isSampleRequired</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Serial</span><span class="o">.</span><span class="n">end</span><span class="p">();</span> <span class="o">//</span> <span class="ow">not</span> <span class="n">sure</span> <span class="k">if</span> <span class="n">needed</span>

  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Wind speed is collected as the number of rotations every 2.5s. The pin is then interrupted for 0.5s so the total can be reset. The total number of rotations is multiplied by 0.9 to get the wind speed as specified by the <a class="reference external" href="https://cdn.shopify.com/s/files/1/0515/5992/3873/files/6410_SS.pdf">Davis cup anemometer manual</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">isr_timer</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">timerCount</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">timerCount</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">windSpeed</span> <span class="o">=</span> <span class="n">rotations</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">;</span>
    <span class="n">rotations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">isSampleRequired</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
    <span class="n">timerCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Wind direction is read as an offset from the orgin position (0 degrees) up to 1023 degrees. This needs to be re-mapped to follow the 360 degrees used for direction.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">getWindDirection</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">//</span><span class="n">vaneValue</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">WindVane_Pin</span><span class="p">);</span> 
 <span class="o">//</span> <span class="n">vaneDirection</span> <span class="o">=</span> <span class="p">(</span><span class="n">vaneValue</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">360.0</span><span class="p">;</span>
  <span class="n">vaneValue</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">WindVane_Pin</span><span class="p">);</span>
  <span class="n">vaneDirection</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">vaneValue</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">359</span><span class="p">);</span>
  <span class="n">calDirection</span> <span class="o">=</span> <span class="n">vaneDirection</span> <span class="o">+</span> <span class="n">VaneOffset</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">calDirection</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span>
    <span class="n">calDirection</span> <span class="o">=</span> <span class="n">calDirection</span> <span class="o">-</span> <span class="mi">360</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">calDirection</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">calDirection</span> <span class="o">=</span> <span class="n">calDirection</span> <span class="o">+</span> <span class="mi">360</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="thesensor.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">The Expendable Wind Sensor</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="windbuild.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Wind Tunnel Build</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Reagan McKinney<br/>
  
      &copy; Copyright 2022, Reagan McKinney.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>